name: "CodeQL"

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  schedule:
    - cron: "25 3 * * 1" # weekly (Mon 03:25 UTC)

jobs:
  analyze:
    name: Analyze (CodeQL)
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write
      issues: write # needed to create GitHub issues

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript-typescript"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # Optional:
          # queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        id: codeql_analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          output: sarif-results
          upload: true

      - name: Create GitHub Issue if critical findings exist
        uses: actions/github-script@v7
        env:
          SARIF_DIR: sarif-results
          ISSUE_TITLE: "ðŸš¨ CodeQL: Critical security findings detected"
          CVSS_THRESHOLD: "8.0"
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const sarifDir = process.env.SARIF_DIR || 'sarif-results';
            const issueTitle = process.env.ISSUE_TITLE || 'CodeQL: Critical security findings detected';
            const cvssThreshold = parseFloat(process.env.CVSS_THRESHOLD || '8.0');

            function listSarifFiles(dir) {
              if (!fs.existsSync(dir)) return [];
              const entries = fs.readdirSync(dir, { withFileTypes: true });
              const files = [];
              for (const e of entries) {
                const full = path.join(dir, e.name);
                if (e.isDirectory()) files.push(...listSarifFiles(full));
                else if (e.isFile() && e.name.toLowerCase().endsWith('.sarif')) files.push(full);
              }
              return files;
            }

            const sarifFiles = listSarifFiles(sarifDir);
            if (sarifFiles.length === 0) {
              core.info(`No SARIF files found in ${sarifDir}. Nothing to evaluate.`);
              return;
            }

            // Collect "critical-like" findings from SARIF:
            // - CodeQL often uses result.level: "error" for high-severity findings
            // - It may also include properties["security-severity"] as a numeric string (CVSS-like)
            const criticalFindings = [];

            for (const file of sarifFiles) {
              const raw = fs.readFileSync(file, 'utf8');
              const sarif = JSON.parse(raw);

              const runs = sarif.runs || [];
              for (const run of runs) {
                const toolDriver = run.tool?.driver;
                const rules = toolDriver?.rules || [];
                const ruleById = new Map(rules.map(r => [r.id, r]));

                const results = run.results || [];
                for (const r of results) {
                  const level = (r.level || '').toLowerCase(); // "error", "warning", "note"
                  const props = r.properties || {};
                  const secSevRaw = props["security-severity"] ?? props.securitySeverity ?? props.security_severity;
                  const secSev = secSevRaw != null ? parseFloat(String(secSevRaw)) : NaN;

                  const isCritical =
                    level === 'error' ||
                    (!Number.isNaN(secSev) && secSev >= cvssThreshold);

                  if (!isCritical) continue;

                  const ruleId = r.ruleId || r.rule?.id || 'unknown-rule';
                  const rule = ruleById.get(ruleId);
                  const ruleName = rule?.name || ruleId;
                  const message = r.message?.text || '(no message)';
                  const location = r.locations?.[0]?.physicalLocation;
                  const artifact = location?.artifactLocation?.uri || '(unknown file)';
                  const region = location?.region;
                  const line = region?.startLine ? `:${region.startLine}` : '';

                  criticalFindings.push({
                    ruleId,
                    ruleName,
                    message,
                    file: artifact,
                    line: line,
                    level,
                    securitySeverity: secSevRaw ?? 'n/a',
                  });
                }
              }
            }

            core.info(`Critical-like findings found: ${criticalFindings.length}`);
            if (criticalFindings.length === 0) return;

            // Avoid duplicate issues: check if an open issue with same title already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100,
            });

            const existing = issues.find(i => i.title === issueTitle);
            if (existing) {
              core.info(`An open issue already exists (#${existing.number}). Skipping creation.`);
              return;
            }

            const top = criticalFindings.slice(0, 20);
            const moreCount = Math.max(0, criticalFindings.length - top.length);

            const bodyLines = [];
            bodyLines.push("CodeQL detected **critical/high security findings** in the latest workflow run.");
            bodyLines.push("");
            bodyLines.push(`**Workflow:** ${context.workflow}`);
            bodyLines.push(`**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`);
            bodyLines.push("");
            bodyLines.push("### Top findings");
            bodyLines.push("");
            for (const f of top) {
              bodyLines.push(`- **${f.ruleName}** (\`${f.ruleId}\`) â€” level: \`${f.level}\`, security-severity: \`${f.securitySeverity}\``);
              bodyLines.push(`  - ${f.file}${f.line}`);
              bodyLines.push(`  - ${f.message}`);
            }
            if (moreCount > 0) {
              bodyLines.push("");
              bodyLines.push(`...and **${moreCount}** more critical-like findings.`);
            }

            const { data: created } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: bodyLines.join("\n"),
              labels: ["security", "codeql", "critical"],
            });

            core.info(`Created issue: #${created.number}`);
